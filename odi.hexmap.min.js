/**
	ODI Leeds hex map in SVG
	Version 0.5
 */
!function(t){var e=t.ODI||{};function i(t,i){if(this.version="0.5",i||(i={}),this._attr=i,this.title="ODI HexMap",this.logging=location.search.indexOf("debug=true")>=0,this.log=function(){if(this.logging||"ERROR"==arguments[0]||"WARNING"==arguments[0]){var t=Array.prototype.slice.call(arguments,0),e=["%c"+this.title+"%c: "+t[1],"font-weight:bold;",""];t.length>2&&(e=e.concat(t.splice(2))),console&&"function"==typeof console.log&&("ERROR"==arguments[0]?console.error.apply(null,e):"WARNING"==arguments[0]?console.warn.apply(null,e):"INFO"==arguments[0]?console.info.apply(null,e):console.log.apply(null,e))}return this},!t)return this.log("ERROR","Unable to find the element to draw into",t),{};"number"!=typeof i.padding&&(i.padding=0);var n,l=i.width||t.offsetWidth||300,p=i.height||t.offsetHeight||150,c=l,f=p,d=l/p,u=!1,x=16;for(var y in this.areas={},this.properties={size:i.size},this.callback={},this.mapping={},t.querySelector(".hexmap-inner")||(this.el=document.createElement("div"),this.el.classList.add("hexmap-inner"),t.appendChild(this.el)),this.options={showgrid:"boolean"==typeof i.grid&&i.grid,showlabel:"boolean"!=typeof i.showlabel||i.showlabel,formatLabel:"function"==typeof i.formatLabel?i.formatLabel:function(t,e){return t.substr(0,3)},minFontSize:"number"==typeof i.minFontSize?i.minFontSize:4},this.style={default:{fill:"#cccccc","fill-opacity":1,"font-size":x,"stroke-width":1.5,"stroke-opacity":1,stroke:"#ffffff"},highlight:{fill:"#1DD3A7"},grid:{fill:"#aaa","fill-opacity":.1}},i.style)i.style[y]&&(this.style[y]||(this.style[y]={}),i.style[y].fill&&(this.style[y].fill=i.style[y].fill),i.style[y]["fill-opacity"]&&(this.style[y]["fill-opacity"]=i.style[y]["fill-opacity"]),i.style[y]["font-size"]&&(this.style[y]["font-size"]=i.style[y]["font-size"]),i.style[y].stroke&&(this.style[y].stroke=i.style[y].stroke),i.style[y]["stroke-width"]&&(this.style[y]["stroke-width"]=i.style[y]["stroke-width"]),i.style[y]["stroke-opacity"]&&(this.style[y]["stroke-opacity"]=i.style[y]["stroke-opacity"]));this.setFontSize=function(t){for(var e in x=t,this.log("MESSAGE","setFontSize",x),this.style.default["font-size"]=x,this.areas)this.areas[e].label&&h(this.areas[e].label,{"font-size":x+"px"});return this},this.setHexSize=function(t){return"number"!=typeof t&&(t=10),i.size=t,this.properties.size=t,this.setFontSize(.4*t),this},this.setHexSize(i.size),this.load=function(t,i,s){function a(t){m.log("INFO","HexJSON",t),m.setMapping(t),"function"==typeof s&&s.call(m,{data:i})}return"function"!=typeof i||s||(s=i,i=""),"string"==typeof t?(this.log("INFO","Loading "+t,i,s),e.ajax(t,{this:this,dataType:"json",success:function(t){a(t)},error:function(e,i){this.log("ERROR","Unable to load "+t,i)}})):"object"==typeof t&&a(t),this};var m=this;return window.addEventListener("resize",function(t){m.resize()}),this.setHexStyle=function(t){var e,i,s,a,r;if(e=this.areas[t],r=this.style.default,i=JSON.parse(JSON.stringify(r)),s="",e.active&&(i.fill=e.fillcolour),e.hover&&(s+=" hover"),e.selected){for(a in this.style.selected)this.style.selected[a]&&(i[a]=this.style.selected[a]);s+=" selected"}return i.class="hex-cell"+s,h(e.hex,i),e.label&&h(e.label,{class:"hex-label"+s}),e},this.toFront=function(t){if(this.log("INFO","toFront",t),this.areas[t]){for(var e in this.areas)this.areas[e].selected&&(console.log(e),a(this.areas[e].hex,n),a(this.areas[e].label,n));a(this.areas[t].hex,n),a(this.areas[t].label,n)}return this},this.regionToggleSelected=function(t,e){this.selected=this.selected==t?"":t;var i,s=this.areas[t];if(s.selected=!s.selected,this.setHexStyle(t),!s.selected&&e)for(i in this.areas)this.areas[i].selected&&(this.areas[i].selected=!1,this.setHexStyle(i));return this},this.regionFocus=function(t){return this.areas[t].hover=!0,this.el.querySelectorAll(".hover").forEach(function(t){t.classList.remove("hover")}),this.setHexStyle(t),this.toFront(t),this},this.regionBlur=function(t){return this.areas[t].hover=!1,this.setHexStyle(t),this},this.regionActivate=function(t){this.areas[t].active=!0,this.setHexStyle(t)},this.regionDeactivate=function(t){this.areas[t].active=!1,this.setHexStyle(t)},this.regionToggleActive=function(t){var e=this.areas[t];e.active=!e.active,this.setHexStyle(t)},this.selectRegion=function(t){var e;for(var i in this.selected=t,this.areas)this.areas[i]&&(e=this.areas[i],t.length>0&&0==i.indexOf(t)?(e.selected=!0,this.setHexStyle(i)):(e.selected=!1,this.setHexStyle(i)));return this},this.on=function(t,e,i){return"function"!=typeof e||i||(i=e,e=""),"function"!=typeof i?this:(this.callback||(this.callback={}),this.callback[t]={fn:i,attr:e},this)},this.moveTo=function(t,e){if(this.selected){var i=t-this.mapping.hexes[this.selected].q,s=e-this.mapping.hexes[this.selected].r;for(var a in this.areas)if(this.areas[a]&&(0==a.indexOf(this.selected)&&(this.areas[a].selected=!0),this.areas[a].selected)){this.mapping.hexes[a].q+=i,this.mapping.hexes[a].r+=s;var r=this.drawHex(this.mapping.hexes[a].q,this.mapping.hexes[a].r);this.areas[a].attr({path:r.path}).update(),this.options.showlabel&&this.areas[a].label&&h(this.areas[a].label,{x:r.x,y:r.y+this.style.default["font-size"]/2,"clip-path":"hex-clip-"+this.mapping.hexes[a].q+"-"+this.mapping.hexes[a].r}),this.areas[a].selected=!1,this.setHexStyle(a)}this.selected=""}},this.size=function(e,o){this.log("INFO","size",e,o),this.el.style.height="",this.el.style.width="",h(t,{style:""}),n&&h(n,{width:0,height:0}),e=Math.min(c,t.offsetWidth),this.el.style.height=e/d+"px",this.el.style.width=e+"px",o=Math.min(f,this.el.offsetHeight),n||(h(n=r("svg"),{xmlns:s,version:"1.1",overflow:"hidden",viewBox:i.viewBox||"0 0 "+e+" "+o,style:"max-width:100%;",preserveAspectRatio:"xMinYMin meet","vector-effect":"non-scaling-stroke"}),a(n,this.el)),h(n,{width:e,height:o}),h(t,{style:"width:"+e+"px;height:"+o+"px"});var u=e/l;return this.properties.size=i.size*u,l=e,p=o,this.el.style.height="",this.el.style.width="",this},this.resize=function(){return console.log("resize",n),this.size(),this},this.initialized=function(){this.create().draw();var e=t.querySelector(".spinner");return e&&e.parentNode.removeChild(e),this},this.create=function(){return n.innerHTML="",u=!1,this},this.setMapping=function(t){this.mapping=t,this.properties||(this.properties={x:100,y:100}),this.properties.x=l/2,this.properties.y=p/2,this.setSize();var e=t.layout.split("-");return this.properties.shift=e[0],this.properties.orientation=e[1],this.initialized()},this.setSize=function(t){return t&&(this.properties.size=t),this.properties.s={cos:this.properties.size*Math.sqrt(3)/2,sin:.5*this.properties.size},this.properties.s.c=this.properties.s.cos.toFixed(2),this.properties.s.s=this.properties.s.sin.toFixed(2),this},this.drawHex=function(t,e,i){var s,a,h,r,o;return this.properties?("number"!=typeof i&&(i=1),i=Math.sqrt(i),s=this.properties.x+t*this.properties.s.cos*2,a=this.properties.y-e*this.properties.s.sin*3,"r"==this.properties.orientation&&("odd"==this.properties.shift&&1==(1&e)&&(s+=this.properties.s.cos),"even"==this.properties.shift&&0==(1&e)&&(s+=this.properties.s.cos)),"q"==this.properties.orientation&&("odd"==this.properties.shift&&1==(1&t)&&(a+=this.properties.s.cos),"even"==this.properties.shift&&0==(1&t)&&(a+=this.properties.s.cos)),o=[["M",[s,a]]],h=this.properties.s.c*i,r=this.properties.s.s*i,"r"==this.properties.orientation?(o.push(["m",[h,-r]]),o.push(["l",[-h,-r,-h,r,0,(this.properties.size*i).toFixed(2),h,r,h,-r]]),o.push(["z",[]])):(o.push(["m",[-r,h]]),o.push(["l",[-r,-h,r,h,(this.properties.size*i).toFixed(2),0,r,h,-r,h]]),o.push(["z",[]])),{array:o,path:function(t){for(var e="",i=0;i<t.length;i++)e+=(t[i][0]?t[i][0]:" ")+(t[i][1].length>0?t[i][1].join(","):" ");return e}(o),x:s,y:a}):this},this.updateColours=function(t){for(var e in this.log("MESSAGE","updateColours",t),t&&(i.colours=t),i.colours||(i.colours=function(){return this.style.default.fill}),this.mapping.hexes)this.mapping.hexes[e]&&("string"==typeof i.colours?this.areas[e].fillcolour=i.colours:this.areas[e].fillcolour=i.colours.call(this,e),this.setHexStyle(e));return this},this.draw=function(){var t,e,s,a;console.log("draw");var c={r:{min:1e100,max:-1e100},q:{min:1e100,max:-1e100}};for(a in this.mapping.hexes)this.mapping.hexes[a]&&(e=this.mapping.hexes[a].q,t=this.mapping.hexes[a].r,e>c.q.max&&(c.q.max=e),e<c.q.min&&(c.q.min=e),t>c.r.max&&(c.r.max=t),t<c.r.min&&(c.r.min=t));c.q.min-=i.padding,c.q.max+=i.padding,c.r.min-=i.padding,c.r.max+=i.padding;var f=(c.q.max+c.q.min)/2,d=(c.r.max+c.r.min)/2;this.properties.x=l/2-2*this.properties.s.cos*f,this.properties.y=p/2+3*this.properties.s.sin*d,this.range=c;var x=function(t){var e="mouseover";if(t.data.hexmap.regionFocus(t.data.region),t.data.hexmap.callback[e]){for(var i in t.data.hexmap.callback[e].attr)t.data.hexmap.callback[e].attr[i]&&(t.data[i]=t.data.hexmap.callback[e].attr[i]);if("function"==typeof t.data.hexmap.callback[e].fn)return t.data.hexmap.callback[e].fn.call(this,t)}},y=function(t){var e="mouseout";if(t.data.hexmap.callback[e]){for(var i in t.data.hexmap.callback[e].attr)t.data.hexmap.callback[e].attr[i]&&(t.data[i]=t.data.hexmap.callback[e].attr[i]);if("function"==typeof t.data.hexmap.callback[e].fn)return t.data.hexmap.callback[e].fn.call(this,t)}},m=function(t){var e="click";if(t.data.hexmap.regionFocus(t.data.region),t.data.hexmap.callback[e]){for(var i in t.data.hexmap.callback[e].attr)t.data.hexmap.callback[e].attr[i]&&(t.data[i]=t.data.hexmap.callback[e].attr[i]);if("function"==typeof t.data.hexmap.callback[e].fn)return t.data.hexmap.callback[e].fn.call(this,t)}};if(this.options.showgrid)for(this.grid=[],e=c.q.min;e<=c.q.max;e++)for(t=c.r.min;t<=c.r.max;t++)s=this.drawHex(e,t),this.grid.push(this.paper.path(s.path).attr({class:"hex-grid","data-q":e,"data-r":t,fill:this.style.grid.fill||"","fill-opacity":this.style.grid["fill-opacity"]||.1,stroke:this.style.grid.stroke||"#aaa","stroke-opacity":this.style.grid["stroke-opacity"]||.2})),this.grid[this.grid.length-1].on("mouseover",{type:"grid",hexmap:this,data:{r:t,q:e}},x).on("mouseout",{type:"grid",hexmap:this,me:b,data:{r:t,q:e}},y).on("click",{type:"grid",hexmap:this,region:a,me:b,data:{r:t,q:e}},m),this.paper.clip({path:s.path,type:"path"}).attr({id:"hex-clip-"+e+"-"+t});this.values={};var g,v,b=this;for(a in this.mapping.hexes)this.mapping.hexes[a]&&(this.values[a]=(this.mapping.hexes[a].p-5e4)/3e4,this.values[a].value<0&&(this.values[a]=0),this.values[a].value>1&&(this.values[a]=1),s=this.drawHex(this.mapping.hexes[a].q,this.mapping.hexes[a].r),u||(h(g=r("path"),{d:s.path,class:"hex-cell","data-q":this.mapping.hexes[a].q,"data-r":this.mapping.hexes[a].r,id:"hex-"+a,"aria-title":this.mapping.hexes[a].n||a}),n.appendChild(g),this.areas[a]={hex:g,selected:!1,active:!0},o("mouseover",g,{type:"hex",hexmap:this,region:a,data:this.mapping.hexes[a],pop:this.mapping.hexes[a].p},x),o("mouseout",g,{type:"hex",hexmap:this,region:a,me:this.areas[a]},y),o("click",g,{type:"hex",hexmap:this,region:a,me:this.areas[a],data:this.mapping.hexes[a]},m),this.options.showlabel&&this.style.default["font-size"]>=this.options.minFontSize&&((v=r("text")).innerHTML=this.options.formatLabel(this.mapping.hexes[a].n,{size:this.properties.size,"font-size":this.style.default["font-size"]}),h(v,{x:s.x,y:s.y+this.style.default["font-size"]/2,id:"hex-"+a+"-label","clip-path":"hex-clip-"+this.mapping.hexes[a].q+"-"+this.mapping.hexes[a].r,"data-q":this.mapping.hexes[a].q,"data-r":this.mapping.hexes[a].r,class:"hex-label","text-anchor":"middle","font-size":this.style.default["font-size"]+"px",title:this.mapping.hexes[a].n||a,_region:a}),n.appendChild(v),this.areas[a].label=v,this.areas[a].labelprops={x:s.x,y:s.y},o("mouseover",v,{type:"hex",hexmap:this,region:a,data:this.mapping.hexes[a],pop:this.mapping.hexes[a].p},x),o("mouseout",v,{type:"hex",hexmap:this,region:a,me:this.areas[a]},y),o("click",v,{type:"hex",hexmap:this,region:a,me:this.areas[a],data:this.mapping.hexes[a]},m))),this.setHexStyle(a),h(this.areas[a].hex,{stroke:this.style.default.stroke,"stroke-opacity":this.style.default["stroke-opacity"],"stroke-width":this.style.default["stroke-width"],title:this.mapping.hexes[a].n,"data-regions":a,style:"cursor: pointer;"}));return u=!0,this},this.selectBySameColour=function(){if(this.selected)for(var t in this.areas)this.areas[t].fillcolour==this.areas[this.selected].fillcolour&&(this.areas[t].selected=!0,this.setHexStyle(t));return this},this.size(),i.file&&this.load(i.file,i.ready),this}e.ready||(e.ready=function(t){"loading"!=document.readyState?t():document.addEventListener("DOMContentLoaded",t)}),e.ajax||(e.ajax=function(t,e){e||(e={});var i=new XMLHttpRequest;return"responseType"in i&&e.dataType&&(i.responseType=e.dataType),i.open(e.method||"GET",t+(e.cache?"?"+Math.random():""),!0),i.onload=function(i){if(this.status>=200&&this.status<400){var s=this.response;"function"==typeof e.success&&e.success.call(e.this||this,s,{url:t,data:e,originalEvent:i})}else"function"==typeof e.error&&e.error.call(e.this||this,i,{url:t,data:e})},"function"==typeof e.error&&(i.onerror=function(i){e.error.call(e.this||this,i,{url:t,data:e})}),i.send(),this}),e.hexmap=function(t,e){return new i(t,e)};var s="http://www.w3.org/2000/svg";function a(t,e){return e.appendChild(t)}function h(t,e){for(var i in e)t.setAttribute(i,e[i]);return t}function r(t){return document.createElementNS(s,t)}function o(t,e,i,s){e&&(e.length||(e=[e]),"function"==typeof s&&e.forEach(function(e){e.addEventListener(t,function(t){t.data=i,s.call(i.this||this,t)})}))}t.ODI=e}(window||this);